include ../../config.mk
include ../../magic.mk

ifeq (linux,$(PLATFORM))
  LD_LIBRARY_PATH := $(LD_LIBRARY_PATH):$(MHA_INSTALL_DIR)
  export LD_LIBRARY_PATH
endif

all:
	$(MAKE) -C flowcharts
	$(MAKE)  MHA_reference.pdf MHA_manual.pdf mhacontrol_manual.pdf
#	$(MAKE) plugins  MHA_manual.pdf mhacontrol_manual.pdf


.PHONY : test images kernel parser plugins copyright mhadoc MHA_plugin_auto_doc.pdf clean

# Don't delete intermediate files
.SECONDARY: 

empty :=
space := $(empty) $(empty)
PLUGINDIRS=$(wildcard ../plugins/*/*/$(PLATFORM_CC)/)
MHA_PLUGINDIRS=$(subst $(space),;,$(PLUGINDIRS))

MHADISTS = MHA-20080023 MHA-HaH compression MHA-FhG MHA-UOL-SigProc MHA-basic MHA-NCA MHA-newfeatures2010 MHA-example-distribution MHA-LiU MHA-Forschergruppe-TpA-devel MHA-ABCIT MHA-Audiologicall MHA-Maartje MHA-cHIRP

REF_CORR = ',s/{\\rm (p\./ {\\sf (p./g'
INHERITED_BY = '/Inherited by/ d'
APPENDIX_CORR = ',s/The Master Hearing Aid (MHA) Page Documentation/Appendix/g'

%/inherit:
	-for tex in $*/latex/*.tex; do \
	(echo $(INHERITED_BY);echo w) | \
	ed $$tex; \
	done

%/refcorr:
	-for tex in $*/latex/*.tex; do \
	(echo $(REF_CORR);echo w) | \
	ed $$tex; \
	done

%/appendix:
	-for tex in $*/latex/*.tex; do \
	(echo $(APPENDIX_CORR);echo w) | \
	ed $$tex; \
	done

test:
	make -C src all

%/copyright:
	-(echo ',s/Generated.*Doxygen/\\copyright{} 2005-2013 H\\"orTech gGmbH, Oldenburg/g';echo w) | \
	ed $*/latex/doxygen.sty
	-(echo ',s/Generated by Doxygen[^\\}]*/\\includegraphics[width=10cm]{..\/..\/flowcharts\/fmt_png\/hoertechlogo.png}/g';echo w) |\
	ed $*/latex/refman.tex


%/htmlcopyright:
	-for i in $*/html/*.html; do (echo ',s/Generated.*by/& Doxygen.<br><b>\&copy; 2005-2013 H\&ouml;rTech gGmbH, Oldenburg<\/b><br>/g';echo ',s/http:\/\/www\.doxygen\.org\/index\.html/http:\/\/www.hoertech.de\//g';echo ',s/doxygen\.png/hoertechlogo.png/g';echo ',s/ 1\.4\.[246] <\/small>/<\/small>/g'; echo w) | \
	ed $$i ; done
#	-(echo ',s/Generated by Doxygen[^\\}]*/\\includegraphics[width=10cm]{..\/..\/flowcharts\/fmt_png\/hoertechlogo.png}/g';echo w) |\
#	ed $*/latex/refman.tex


mhakernel.pdf: kernel
	make mhakernel/copyright
	make -C mhakernel/latex refman.pdf
	cp mhakernel/latex/refman.pdf $@

mhastructure.pdf: mhastructure
	make MHA-Structure/copyright
	TEXINPUTS="./:../../:../../flowcharts/fmt_png/:" make -C MHA-Structure/latex refman.pdf
	cp MHA-Structure/latex/refman.pdf $@

MHA_reference.pdf: images mhadoc
	make mhadoc/inherit
	make mhadoc/copyright
	make mhadoc/refcorr
	make mhadoc/appendix
	cp optparams.sty mhadoc/latex
	cp flowcharts/fmt_png/*.png mhadoc/latex
	cp flowcharts/fmt_pdf/*.pdf mhadoc/latex
	make -C mhadoc/latex refman.pdf
	cp mhadoc/latex/refman.pdf $@

MHA_manual.pdf: user_manual/MHA_manual.pdf
	cp $< $@

mhacontrol_manual.pdf: user_manual/mhacontrol_manual.pdf
	cp $< $@

hearcom_receiver_corr.pdf: user_manual/hearcom_receiver_corr.pdf
	cp $< $@

.PHONY : images user_manual/MHA_manual.pdf user_manual/mhacontrol_manual.pdf

user_manual/MHA_manual.pdf:
	make -C user_manual MHA_manual.pdf

user_manual/mhacontrol_manual.pdf:
	make -C user_manual mhacontrol_manual.pdf

user_manual/hearcom_receiver_corr.pdf:
	make -C user_manual hearcom_receiver_corr.pdf

images:
	make -C flowcharts

kernel: images
	rm -Rf mhakernel/latex
	rm -Rf mhakernel/html
	doxygen mhakernel.cfg

mhadoc: images
	rm -Rf mhadoc
	doxygen mhaextern.cfg
	make mhadoc/htmlcopyright
	cp hoertechlogo.png mhadoc/html/

mhastructure: images 
	rm -Rf MHA-Structure/latex
	doxygen MHA-Structure.cfg

parser:
	doxygen mhaparser.cfg

plugins: $(MHADISTS:=_plugins.pdf)
#	doxygen mhaplugins.cfg

MHA_plugin_auto_doc.pdf:
	rm -f MHA_plugin_auto_doc.*
	MHA_PARSER_PRECISION=6 ./create_doc_for_all_plugins.sh

%_plugin.list: ../../distributions/distributions.csv
	../../distributions/print_plugin_list $< $* $(PLATFORM_CC) | sort > $@

%_plugin_section.tex: %_plugin.list
	MHA_PARSER_PRECISION=5 LD_LIBRARY_PATH="$(LD_LIBRARY_PATH):$(MATLAB_LIBS)" MHA_LIBRARY_PATH="$(MHA_PLUGINDIRS)" generatemhaplugindoc -o $@ -c subsection -p subsubsection `cat $<` 

%_plugins.tex: %_plugin.list
	MHA_PARSER_PRECISION=5 LD_LIBRARY_PATH="$(LD_LIBRARY_PATH):$(MATLAB_LIBS)" MHA_LIBRARY_PATH="$(MHA_PLUGINDIRS)" generatemhaplugindoc -o temp$@ -c section -p subsection `cat $<` 
	cat plugin_doc_prefix.tex | sed -e 's/__DISTID__/$*/g' > $@
	cat temp$@ >> $@
	cat plugin_doc_postfix.tex >> $@
	rm -f temp$@

%.pdf: %.tex
	TEXINPUTS=flowcharts/fmt_png::. pdflatex -file-line-error $<
	-bibtex $*
	TEXINPUTS=flowcharts/fmt_png::. pdflatex -file-line-error $<
	makeindex $*
	TEXINPUTS=flowcharts/fmt_png::. pdflatex -file-line-error $<
	rm -f $*.{aux,dvi,log,toc,out,idx,ilg}

clean:
	rm -f $(MHADISTS:=_plugins.*) *~
